# ================================
# ğŸŒ¿ StepOne ë°±ì—”ë“œ (Day6: Gemini ì—°ê²°)
# ================================
#
# ì´ íŒŒì¼ì€ StepOne ì•±ì˜ "ì„œë²„(ë°±ì—”ë“œ)" ì½”ë“œì…ë‹ˆë‹¤.
# ì¦‰, ì‚¬ìš©ìê°€ ì›¹ì‚¬ì´íŠ¸(í”„ë¡ íŠ¸ì—”ë“œ)ì—ì„œ ê¸€ì„ ì“°ë©´,
# ê·¸ ë‚´ìš©ì„ FastAPIê°€ ë°›ì•„ì„œ â†’ Gemini AIì— ì „ë‹¬í•˜ê³  â†’ ë‹¤ì‹œ ì‘ë‹µì„ ëŒë ¤ì£¼ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
#
# -------------------------------
# ğŸŒ ì „ì²´ íë¦„ ì´í•´í•˜ê¸°
# -------------------------------
# [1] ì‚¬ìš©ìê°€ index.html(ì›¹ í˜ì´ì§€)ì—ì„œ ê¸€ì„ ì…ë ¥
# [2] app.js(JavaScript)ê°€ ê·¸ ê¸€ì„ /api/plan ì£¼ì†Œë¡œ ë³´ëƒ„
# [3] main.py(FastAPI)ê°€ ê·¸ ë°ì´í„°ë¥¼ ë°›ì•„ Gemini APIì— ìš”ì²­
# [4] Geminiê°€ ëŒ€ë‹µ(JSON)ì„ ë³´ë‚´ë©´ FastAPIê°€ ê·¸ëŒ€ë¡œ ì „ë‹¬
# [5] ë‹¤ì‹œ JSê°€ í™”ë©´(chatContainer)ì— í‘œì‹œ
#
# ğŸ’¡ ì¦‰, ì´ main.pyëŠ” "ì¤‘ê°„ ì „ë‹¬ì" ì—­í• ì´ì—ìš”.
# ë¸Œë¼ìš°ì €(í”„ë¡ íŠ¸ì—”ë“œ) â†” FastAPI(ë°±ì—”ë“œ) â†” Gemini(API)
# -------------------------------


# ================================
# â‘  í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
# ================================
# FastAPI: ì›¹ ì„œë²„ë¥¼ ì‰½ê²Œ ë§Œë“¤ ìˆ˜ ìˆëŠ” Python í”„ë ˆì„ì›Œí¬
# StaticFiles: HTML, CSS, JS ê°™ì€ ì •ì  íŒŒì¼(í™”ë©´ ì½”ë“œ) ì œê³µìš©
# RedirectResponse: íŠ¹ì • ì£¼ì†Œë¡œ ìë™ ì´ë™ì‹œí‚¬ ë•Œ ì‚¬ìš©
# BaseModel: API ìš”ì²­ ë°ì´í„°ì˜ í˜•ì‹ì„ ì •ì˜í•  ë•Œ ì‚¬ìš©
# os, httpx, json: ì™¸ë¶€ API í˜¸ì¶œ ë° ë°ì´í„° ì²˜ë¦¬ìš©
# dotenv: .env íŒŒì¼ì— ìˆëŠ” ë¹„ë°€í‚¤(API Key)ë¥¼ ë¶ˆëŸ¬ì˜¬ ë•Œ ì‚¬ìš©
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from fastapi.responses import RedirectResponse
from pydantic import BaseModel
import os, httpx, json
from dotenv import load_dotenv


# ================================
# â‘¡ í™˜ê²½ë³€ìˆ˜(.env) ë¶ˆëŸ¬ì˜¤ê¸°
# ================================
# .env íŒŒì¼ì—ëŠ” GEMINI_API_KEYê°€ ì €ì¥ë˜ì–´ ìˆìŒ
# (ë³´ì•ˆì„ ìœ„í•´ GitHubì—ëŠ” ì ˆëŒ€ ì˜¬ë¦¬ì§€ ì•ŠìŒ)
load_dotenv()  # .env íŒŒì¼ ì½ê¸°


# ================================
# â‘¢ FastAPI ì•± ìƒì„±
# ================================
# FastAPIëŠ” Flaskì™€ ë¹„ìŠ·í•˜ì§€ë§Œ í›¨ì”¬ ë¹ ë¥´ê³ , íƒ€ì… ì§€ì›ì´ ì¢‹ì•„ìš”.
app = FastAPI()


# ================================
# â‘£ ì •ì  íŒŒì¼(public í´ë”) ì—°ê²°
# ================================
# ë¸Œë¼ìš°ì €ì—ì„œ HTML, CSS, JSë¥¼ ë³¼ ìˆ˜ ìˆê²Œ í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
# ì˜ˆ: /public/index.html â†’ ì‹¤ì œ public í´ë”ì˜ index.html íŒŒì¼ì„ ì „ë‹¬
app.mount("/public", StaticFiles(directory="public"), name="public")


# ================================
# â‘¤ ë£¨íŠ¸("/") ì ‘ì† ì‹œ index.htmlë¡œ ìë™ ì´ë™
# ================================
# ì‚¬ìš©ìê°€ ê·¸ëƒ¥ http://localhost:8000 ìœ¼ë¡œ ì ‘ì†í•˜ë©´
# ìë™ìœ¼ë¡œ public/index.html ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë©ë‹ˆë‹¤.
@app.get("/")
async def root():
    return RedirectResponse(url="/public/index.html")


# ================================
# â‘¥ ìš”ì²­ ë°ì´í„° ëª¨ë¸ ì •ì˜ (í´ë˜ìŠ¤)
# ================================
# í”„ë¡ íŠ¸ì—”ë“œ(JS)ì—ì„œ ë³´ë‚¼ ë°ì´í„°ì˜ í˜•íƒœë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
# ì˜ˆ: {"text": "ìš”ì¦˜ ë„ˆë¬´ ë¬´ê¸°ë ¥í•´ìš”", "emotion": "low", "intent": "habit"}
class PlanRequest(BaseModel):
    text: str
    emotion: str
    intent: str


# ================================
# â‘¦ Gemini API ì„¤ì •
# ================================
# ì‹¤ì œ AI ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ê¸° ìœ„í•œ URLì…ë‹ˆë‹¤.
# Googleì˜ Gemini 1.5 Pro ëª¨ë¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
GEMINI_URL = (
    "https://generativelanguage.googleapis.com/v1beta/models/"
    "gemini-1.5-pro-latest:generateContent"
)


# ================================
# â‘§ /api/plan API ì—”ë“œí¬ì¸íŠ¸
# ================================
# í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‚¬ìš©ìê°€ ë¬¸ì¥ì„ ì…ë ¥í•˜ë©´
# /api/plan ìœ¼ë¡œ POST ìš”ì²­ì´ ë“¤ì–´ì˜µë‹ˆë‹¤.
# â†’ FastAPIê°€ ê·¸ ë°ì´í„°ë¥¼ ë°›ì•„ Geminiì— ì „ë‹¬í•˜ê³ ,
# â†’ Geminiì˜ ëŒ€ë‹µ(JSON)ì„ ê·¸ëŒ€ë¡œ ë¸Œë¼ìš°ì €ë¡œ ëŒë ¤ì¤ë‹ˆë‹¤.
@app.post("/api/plan")
async def plan_endpoint(req: PlanRequest):
    # -------------------------------
    # â‘§-1) API Key í™•ì¸
    # -------------------------------
    api_key = os.getenv("GEMINI_API_KEY")
    if not api_key:
        return {
            "message": "âš ï¸ Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ì–´ìš”. .env íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.",
            "emotion": "healing",
            "tags": ["error"]
        }

    # -------------------------------
    # â‘§-2) Geminiì—ê²Œ ë³´ë‚¼ í”„ë¡¬í”„íŠ¸ ë§Œë“¤ê¸°
    # -------------------------------
    # GeminiëŠ” ë‹¨ìˆœíˆ í…ìŠ¤íŠ¸ë¥¼ ë°›ëŠ” ê²ƒì´ ì•„ë‹ˆë¼,
    # ìš°ë¦¬ê°€ ì›í•˜ëŠ” "í˜•ì‹"ê³¼ "í†¤"ì„ ì •í™•íˆ ì•Œë ¤ì¤˜ì•¼ ì˜¬ë°”ë¥´ê²Œ ì‘ë‹µí•©ë‹ˆë‹¤.
    prompt = f"""
    ë‹¹ì‹ ì€ ì €ì—ë„ˆì§€ ì‚¬ìš©ìë¥¼ ìœ„í•œ ê°ì • ì½”ì¹˜ì…ë‹ˆë‹¤.
    ë‹¤ìŒ ì •ë³´ë¥¼ ì°¸ê³ í•´ 180~280ì ì´ë‚´ì˜ ë”°ëœ»í•œ 2ë¬¸ì¥ìœ¼ë¡œ ëŒ€ë‹µí•˜ì„¸ìš”.
    í†¤ì€ "ì´í•´ â†’ í•œ ê±¸ìŒ", ì£„ì±…ê° ê¸ˆì§€.
    JSON í˜•íƒœë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.

    ì…ë ¥ ë¬¸ì¥: {req.text}
    ê°ì • ìƒíƒœ: {req.emotion}
    ì˜ë„: {req.intent}

    ì˜ˆì‹œ ì¶œë ¥:
    {{
      "message": "ğŸŒ¿ ë§ˆìŒì´ ì§€ì³¤ì„ ë• ì²œì²œíˆ ìˆ¨ì„ ê³ ë¥´ì„¸ìš”. ì˜¤ëŠ˜ì€ ìì‹ ì—ê²Œ ë‹¤ì •í•˜ê²Œ ëŒ€í•´ì£¼ì„¸ìš”.",
      "emotion": "healing",
      "tags": ["íšŒë³µ","ì•ˆì •"]
    }}
    """

    # -------------------------------
    # â‘§-3) Gemini API ìš”ì²­ ë³´ë‚´ê¸°
    # -------------------------------
    try:
        async with httpx.AsyncClient(timeout=10.0) as client:
            res = await client.post(
                f"{GEMINI_URL}?key={api_key}",
                json={"contents": [{"parts": [{"text": prompt}]}]},
            )
            res.raise_for_status()  # ì—ëŸ¬ ì½”ë“œ(4xx, 5xx) ë°œìƒ ì‹œ ì˜ˆì™¸ ì²˜ë¦¬
            data = res.json()

            # Geminiê°€ ì¤€ ì‘ë‹µì€ JSON ì•ˆì— ë˜ ë¬¸ìì—´(JSON)ì´ ë“¤ì–´ìˆì–´ìš”.
            # ê·¸ë˜ì„œ í•œ ë²ˆ ë” json.loads()ë¡œ íŒŒì‹±í•´ì•¼ í•¨.
            text = data["candidates"][0]["content"]["parts"][0]["text"]
            j = json.loads(text)
            return j  # {"message": "...", "emotion": "...", "tags": [...]}

    # -------------------------------
    # â‘§-4) ì‹¤íŒ¨ ì‹œ í´ë°±(fallback) ì‘ë‹µ
    # -------------------------------
    except Exception as e:
        print("âš ï¸ Gemini í˜¸ì¶œ ì‹¤íŒ¨:", e)
        return {
            "message": "ğŸŒ¿ ì„œë²„ ì—°ê²°ì´ ì ì‹œ ë¶ˆì•ˆì •í•´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
            "emotion": "healing",
            "tags": ["í´ë°±"]
        }


# ================================
# âœ… ì‹¤í–‰ ë°©ë²• ìš”ì•½
# ================================
# 1ï¸âƒ£ .env íŒŒì¼ ë§Œë“¤ê¸° (main.pyì™€ ê°™ì€ í´ë”ì— ìƒì„±)
#     GEMINI_API_KEY=AIzaSyXXX...(ë³¸ì¸ í‚¤)
#
# 2ï¸âƒ£ ì‹¤í–‰í•˜ê¸°
#     uvicorn main:app --reload
#
# 3ï¸âƒ£ ë¸Œë¼ìš°ì € ì ‘ì†
#     http://127.0.0.1:8000
#     â†’ ìë™ìœ¼ë¡œ /public/index.htmlë¡œ ì´ë™
#
# 4ï¸âƒ£ ì…ë ¥ í…ŒìŠ¤íŠ¸
#     ë¬¸ì¥ ì…ë ¥ â†’ FastAPI â†’ Gemini â†’ AI ì‘ë‹µ í‘œì‹œ
#
# ================================
# ğŸ“˜ ì „ì²´ êµ¬ì¡° ë³µìŠµ (ì •ë¦¬)
# ================================
# [Frontend: public/]
#   â”œâ”€ index.html   â†’ í™”ë©´ êµ¬ì„±
#   â”œâ”€ style.css    â†’ ìŠ¤íƒ€ì¼(ë””ìì¸)
#   â”œâ”€ app.js       â†’ ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬ + /api ì—°ê²°
# [Backend: app/ or root/]
#   â””â”€ main.py      â†’ FastAPI ì„œë²„ + Gemini ì—°ê²°
#
# ğŸŒ± ë‹¹ì‹ ì´ ë§Œë“  ì•±ì€ ì´ì œ "ì§„ì§œ AI ì½”ì¹˜"ë¡œ ì‘ë™í•©ë‹ˆë‹¤!
# ================================
